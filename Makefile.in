prefix     := @prefix@
abs_srcdir := @abs_srcdir@
libdir     := ${prefix}/lib
bindir     := ${prefix}/bin
version    := @PACKAGE_VERSION@
instdir    := ${libdir}/ptxdist-${version}

all:
	@echo "building lxdialog..."
	cp ${abs_srcdir}/scripts/ptx-modifications/Makefile.lxdialog.ptx ${abs_srcdir}/scripts/lxdialog/Makefile
	cd ${abs_srcdir}/scripts/lxdialog && make
	@echo "building conf..."
	cd ${abs_srcdir}/scripts/kconfig && make conf
	@echo "building mconf..."
	cd ${abs_srcdir}/scripts/kconfig && make mconf
	@echo "done."
	@touch .done

install: all 
	@echo "installing PTXdist to ${DESTDIR}${prefix}..."
	@rm -fr ${DESTDIR}${instdir}
	@mkdir -p ${DESTDIR}${instdir}
	@test -d ${DESTDIR}${instdir} || exit 1
	@touch ${DESTDIR}${instdir} || exit 1 
	@echo "installing PTXdist to ${DESTDIR}${prefix}/bin..."
	tar -C ${abs_srcdir} -cf - --exclude .svn --exclude state --exclude debian . | tar -C ${DESTDIR}${instdir} -xvf -
	@mkdir -p ${DESTDIR}${prefix}/bin
	@rm -f ${DESTDIR}${prefix}/bin/ptxdist
	@ln -sf ${instdir}/bin/ptxdist ${DESTDIR}${prefix}/bin/ptxdist-${version}
	@ln -sf ${instdir}/bin/ptxdist ${DESTDIR}${prefix}/bin/ptxdist

clean:
	rm -f scripts/lxdialog/lxdialog
	rm -f scripts/lxdialog/Makefile
	rm -f scripts/kconfig/conf
	rm -f scripts/kconfig/zconf.tab.c
	rm -f scripts/kconfig/lex.zconf.c
	rm -f scripts/kconfig/lex.backup
	rm -f scripts/kconfig/lkc_defs.h
	rm -f scripts/kconfig/mconf
	rm -f .done

dist:
	PTXDIST_TOPDIR=$(shell pwd); \
	tmpdir=`mktemp -d /tmp/ptxdist.XXXXXX`; \
	cp -a $$PTXDIST_TOPDIR $$tmpdir/ptxdist-$(version); \
	cd $$tmpdir/ptxdist-$(version); make distclean; \
	find $$tmpdir/ptxdist-$(version) -name ".svn" | xargs rm -fr; \
	rm -f $$tmpdir/ptxdist-$(version)/.done; \
	cd $$tmpdir; \
	tar -zcf ptxdist-$(version)-patches.tgz ptxdist-$(version)/patches; \
	rm -fr ptxdist-$(version)/patches; \
	tar -zcf ptxdist-$(version).tgz ptxdist-$(version); \
	cd $$PTXDIST_TOPDIR; \
	mv $$tmpdir/ptxdist-$(version).tgz .; \
	mv $$tmpdir/ptxdist-$(version)-patches.tgz .; \
	rm -fr $$tmpdir; \
	ls -l ptxdist-*

deb:
	dpkg-buildpackage -rfakeroot

distclean: clean
	rm -fr Makefile
	rm -fr build-stamp
	rm -fr debian/ptxdist
	rm -f  rules/ptxdist-version.in
	rm -fr config.log config.status autom4te.cache scripts/ptxdistvars.sh

maintainer-clean: distclean
	rm -f configure

