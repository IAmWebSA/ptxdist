#!/bin/bash

OURDIR="$(dirname "${0}")"
TST="${1}"
shift

if [ ! -e "${PTXDIST_BOARDSETUP}" ]; then
	echo "Please run 'ptxdist boardsetup' first!"
	exit 1
fi

KSCRIPT="${PTXDIST_WORKSPACE}/tests/${TST}.kermit"
if [ ! -e "${KSCRIPT}" ]; then
	KSCRIPT="${OURDIR}/${TST}.kermit"
	if [ ! -e "${KSCRIPT}" ]; then
		echo "No kermit-script for ${TST} found!"
		exit 1
	fi
fi

LIB="${OURDIR}/libptxdisttest.kermit"
if [ ! -e "${LIB}" ]; then
	echo "Could not find ${LIB}!"
	exit 1
fi

TMPFILE="$(mktemp "${PTXDIST_TEMPDIR}/kwrapper.XXXXXX")"

#
# we _must_ set the variables in kermit using 'define'!
# '.' has a bug there (patch already mainlined).
#
sed -e 's/^\(PTXCONF_BOARDSETUP_[A-Z0-9_]*\)=/define \1 /' "${PTXDIST_BOARDSETUP}" > "${TMPFILE}"
# FIXME: add PTXDIST_TEST_vars from environment, too

"${KSCRIPT}" "${LIB}" "${TMPFILE}" "${@}"

rm -f "${TMPFILE}"
