From: Markus Pargmann <mpa@devmp.org>
Date: Wed, 3 Jun 2015 11:06:02 +0200
Subject: [PATCH] module_manager: Fix directory detection

d_type may be incorrect. Use fstatat as fallback.

Signed-off-by: Markus Pargmann <mpa@devmp.org>
---
 src/core/module_manager.c | 23 ++++++++++++++++++++++-
 1 file changed, 22 insertions(+), 1 deletion(-)

diff --git a/src/core/module_manager.c b/src/core/module_manager.c
index 77931ce97727..3f30042d22f1 100644
--- a/src/core/module_manager.c
+++ b/src/core/module_manager.c
@@ -27,6 +27,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sys/types.h>
+#include <sys/stat.h>
 
 #include <klib/list.h>
 #include <klib/printk.h>
@@ -191,10 +192,30 @@ int mod_mgr_init(struct mod_mgr *mm, const char *mod_dir)
 	}
 
 	while ((de = readdir(md))) {
-		if (de->d_type != DT_DIR) {
+		struct stat st;
+		int ret;
+
+		if (de->d_type != DT_UNKNOWN && de->d_type != DT_DIR) {
 			printk(KERN_DEBUG "%s is no directory, continuing\n",
 					de->d_name);
 			continue;
+		} else if (de->d_type == DT_UNKNOWN) {
+			/*
+			 * d_type may not be available on a filesystem, check
+			 * again with fstatat
+			 */
+			ret = fstatat(dirfd(md), de->d_name, &st, 0);
+			if (ret) {
+				printk(KERN_ERR "Failed to stat %s\n",
+				       de->d_name);
+				return ret;
+			}
+
+			if (!S_ISDIR(st.st_mode)) {
+				printk(KERN_DEBUG "%s is no directory, continuing\n",
+				       de->d_name);
+				continue;
+			}
 		}
 		if (!strcmp(de->d_name, ".") || !strcmp(de->d_name, ".."))
 			continue;
